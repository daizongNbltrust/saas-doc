## saas-v1.5.0升级文档
### 调整说明
- 本次saas升级须配合hub V0.13.1+版本
- 更新了权限列表，需要重新跑一边role service, node upsert.js脚本
- superadmin增加了sync hub blockchain/asset的功能，使用此功能前提是需要在启动hub和role service时要定义相同的环境变量JP_SECRET, 以保证hub和saas通信加密
- 使用V1.5.0时, saas frontend/backend/admin需要升级为相同的版本，注意新版本和V1.4.0不兼容(前端可能因为最新后端返回字段不一致导致显示不正常)

#### 部署步骤
1. 停止saas服务
2. 停止hub服务
3. 停止service role服务
4. 备份saas postgres数据库
5. 备份hub mongo数据库
6. 更新saas backend/frontend/superadmin包
7. 在role service所在机器上运行拉取最新代码并执行node upsert.js脚本
```bash
git clone https://github.com/nbltrust/saas-doc.git
cd saas-doc
git pull
cd ./initSaasRole
npm i
node upsert.js
``` 
8. 增加JP_SECRET环境变量使用pm2启动hub(最新pm2文件已包含JP_SECRET环境变量，可以使用不同的JP_SECRET值)
9. 增加JP_SECRET环境变量使用pm2启动role service(最新pm2文件已包含JP_SECRET环境变量，可以使用不同的JP_SECRET值)
10. 在consul:8500 UI界面查看各服务是否启动正常
11. 使用pm2启动saas backend
12. nginx重新配置，指向最新的saas frontend打包文件
13. nginx重新配置，指向最新的saas admin frontend打包文件

#### 注意点
1. 部署saas之前需要保证hub已经正常启动
2. 云端部署可能会因为部分端口未开导致通信失败
  - saas所在机器需要访问hub master 6666， 7001端口
  - hub master需要向saas发送回调，需要可以访问saas-backend:8091端口
3. nginx域名配置问题，以下为我们内部域名配置，可做参考
	- saas有两个前端服务，三个后台服务，最好都配置域名

|ip| 端口 |服务 | 域名|
|--|--|--|--|
|  |  |saas前端|https://saas.xxxx.io|
|  | 8094 |saas admin svr|https://saas-bg.xxxx.io|
|  | 8092 |saas api svr|https://saas-api.xxxx.io|
|  |  |saas admin前端|https://saas-admin.xxxx.io|
|  | 8093 |saas admin后端|https://saas-superadmin.xxxx.io|
4. 部署完成后可以访问saas前端和saas admin前端验证是否工作正常
